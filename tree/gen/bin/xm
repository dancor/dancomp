#!/usr/bin/env python3

from optparse import OptionParser
from time import sleep
import cmd_util as cu
import sys
import wmv_lib as wmv
import os

usage = ''
opt_p = OptionParser(usage)
opt_p.add_option("-a", "--adjust-only", action="store_true")
opt_p.add_option("-r", "--run-only", action="store_true")
opt_p.add_option("-z", "--asia", action="store_true")
opt_p.add_option("-v", "--verbose", action="store_true")
(opts, args) = opt_p.parse_args()
pos = args[0]
extra_args = args[1:]

s_map = {
    "b1": (1, 0),
    "b2": (2, 10),
    "b3": (3, 0),
    "b4": (4, 10),
    "a1": (11, 0),
    "a2": (12, 5),
    "a3": (13, 0),
    "lb1": (21, 0),
    "lb2": (22, 0),
    "lb3": (23, 0),
    "lb4": (24, 0),
    "la1": (7, 0),
    "la2": (8, 0),
    "la3": (9, 0),
    "A1": (1, 0),
    "A2": (2, 5),
    "A3": (3, 0),
    "lA1": (7, 0),
    "lA2": (8, 0),
    "lA3": (9, 0),
}

if pos[0] == "h":
    (s, gray) = s_map[pos[1:]]
else:
    (s, gray) = s_map[pos]

pos = pos.lower()

def coord(n):
    if n >= 0:
        return "+" + str(n)
    else:
        return str(n)

x, y, w, h = wmv.rect_chars(pos)
if opts.asia:
    title = pos[0] + "-asia-" + pos[1:]
    s += 10
else:
    title = pos
if not opts.adjust_only:
    if opts.asia:
        if gray:
            col_args = "--tab-with-profile asia_gray"
        else:
            col_args = "--tab-with-profile asia"
        cmd = "gnome-terminal -t " + cu.arg_esc(title) + " " + col_args + \
            " -e /usr/local/bin/s\ " + cu.arg_esc(str(s)) + " &"
    else:
        if gray:
            #col_args = ["-bg", "gray%s" % gray]
            col_args = ["-bg", "gray5"]
        else:
            col_args = []
        geom_arg = "%dx%d%s%s" % (w, h, coord(x), coord(y))
        cmd = ["xtsp", str(s), title, "-geometry", geom_arg] + col_args + \
            extra_args
    if opts.verbose:
        print(cmd)
    env_mod = os.environ
    env_mod["TMUX"] = ""
    cu.cmd_wait(cmd, env=env_mod)
if not opts.run_only:
    rect = wmv.rect(pos)
    cmd = " ".join(cu.args_esc(["wmctrl", "-r", title, "-e",
        ",".join([str(i) for i in [0] + list(rect)])])) + " &"
    if opts.verbose:
        print(cmd)
    sleep(1.5)
    # Why does wmctrl return 1 all the time?
    cu.cmd_wait(cmd, can_fail=True)
    if opts.asia:
        # Must run twice for "asia" mode since gnome-terminal is weird now.
        sleep(0.5)
        cu.cmd_wait(cmd, can_fail=True)
