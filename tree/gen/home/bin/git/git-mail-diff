#!/usr/bin/env python3
# send diff email with text

import cmd_util as cu
import os
import subprocess as spc
import sys

comm = "git log -1"
p = spc.Popen(comm, shell=True, stdout=spc.PIPE)
p.wait()
commit_lines = [l[4:] for l in p.stdout.readlines()[4:]]

comm = "git log -1 | grep -oP '(?<=  Reviewed [bB]y: ).*'"
p = spc.Popen(comm, shell=True, stdout=spc.PIPE)
p.wait()
ls = p.stdout.readlines()
if len(ls) != 1:
    print >> sys.stderr, 'weird output extracting reviewers: '
    print >> sys.stderr, ls
# you might be on a weird machine as a weird user
# at least let you set an env var to deal
user = os.environ.get('FBUSER')
if not user:
    user = os.environ.get('USER')
rs.append(user)
rs = ls[0][:-1].split(', ') + [user]

s = 'diff:' + commit_lines[0][:-1]

commit_msg = ''.join(commit_lines)

args = sys.argv[1:]

# -l bc ansidiff is quite slow for some diffs,
#       and even (much) slower without -l
comm = "git diff HEAD{\^,} | ansidiff -l -c " + cu.arg_esc(commit_msg)
if args:
    comm += " | htmail -s " + cu.arg_esc(s) + " " + \
        " ".join([cu.arg_esc(r) for r in rs])
else:
    # could use $PAGER here, but no one can really be trusted with -R stuff
    comm += " term | less -R"
#print comm
spc.Popen(comm, shell=True).wait()
